/**
 * EMAIL BENACHRICHTIGUNGEN
 * 
 * Diese Datei konfiguriert Email-Benachrichtigungen für Icinga2.
 * 
 * SETUP:
 * 1. Email-Adressen unter "USERS" anpassen
 * 2. SMTP-Konfiguration in /config/msmtp/msmtprc anpassen
 * 3. TimePeriods nach Bedarf aktivieren
 */

// ============================================================
// ZEITRÄUME (TimePeriods)
// ============================================================

/**
 * 24/7 - Immer benachrichtigen
 */
object TimePeriod "24x7" {
    display_name = "24 Stunden, 7 Tage"
    ranges = {
        monday    = "00:00-24:00"
        tuesday   = "00:00-24:00"
        wednesday = "00:00-24:00"
        thursday  = "00:00-24:00"
        friday    = "00:00-24:00"
        saturday  = "00:00-24:00"
        sunday    = "00:00-24:00"
    }
}

/**
 * Geschäftszeiten - Mo-Fr 8-18 Uhr
 * Aktivieren: period = "business-hours" in Notification setzen
 */
object TimePeriod "business-hours" {
    display_name = "Geschäftszeiten (Mo-Fr 8-18 Uhr)"
    ranges = {
        monday    = "08:00-18:00"
        tuesday   = "08:00-18:00"
        wednesday = "08:00-18:00"
        thursday  = "08:00-18:00"
        friday    = "08:00-18:00"
    }
}

/**
 * Erweiterte Zeiten - Mo-Sa 7-22 Uhr
 */
object TimePeriod "extended-hours" {
    display_name = "Erweiterte Zeiten (Mo-Sa 7-22 Uhr)"
    ranges = {
        monday    = "07:00-22:00"
        tuesday   = "07:00-22:00"
        wednesday = "07:00-22:00"
        thursday  = "07:00-22:00"
        friday    = "07:00-22:00"
        saturday  = "07:00-22:00"
    }
}

// ============================================================
// USERS - Empfänger der Benachrichtigungen
// ============================================================

/**
 * User Template - Basis für alle Notification-User
 */
template User "generic-user" {
    enable_notifications = true
    period = "24x7"  // Ändern zu "business-hours" für nur Geschäftszeiten
    
    // Wann bei Hosts benachrichtigen
    states = [ Up, Down ]
    types = [ Problem, Acknowledgement, Recovery ]
}

/**
 * ADMIN USER
 * TODO: Email-Adresse anpassen!
 */
object User "admin" {
    import "generic-user"
    display_name = "Administrator"
    
    // === HIER EMAIL ANPASSEN ===
    email = "admin@example.com"  // <-- ÄNDERN!
    
    // Optional: Nur bei bestimmten Zuständen
    // states = [ Down, Critical ]
}

/**
 * TEAM/GRUPPE
 * TODO: Email-Adresse anpassen!
 */
object User "team" {
    import "generic-user"
    display_name = "Team Benachrichtigung"
    
    // === HIER EMAIL ANPASSEN ===
    email = "team@example.com"  // <-- ÄNDERN!
    
    // Nur während Geschäftszeiten benachrichtigen
    // period = "business-hours"
}

/**
 * BEREITSCHAFT (für kritische Systeme)
 * TODO: Email-Adresse anpassen!
 */
object User "oncall" {
    import "generic-user"
    display_name = "Bereitschaft"
    
    // === HIER EMAIL ANPASSEN ===
    email = "bereitschaft@example.com"  // <-- ÄNDERN!
    
    // Immer benachrichtigen (24x7)
    period = "24x7"
    
    // Nur bei kritischen Zuständen
    states = [ Down, Critical ]
}

// ============================================================
// USER GROUPS
// ============================================================

object UserGroup "admins" {
    display_name = "Administratoren"
    assign where user.name == "admin"
}

object UserGroup "icingaadmins" {
    display_name = "Icinga Admins"
    assign where user.name == "admin" || user.name == "team"
}

// ============================================================
// NOTIFICATION COMMANDS
// Diese Scripts senden die eigentlichen Emails
// ============================================================

object NotificationCommand "mail-host-notification" {
    command = [ ConfigDir + "/scripts/mail-host-notification.sh" ]
    
    arguments = {
        "-4" = "$notification.host.address$"
        "-6" = "$notification.host.address6$"
        "-b" = "$notification.author$"
        "-c" = "$notification.comment$"
        "-d" = {
            required = true
            value = "$icinga.long_date_time$"
        }
        "-l" = "$notification.host.name$"
        "-n" = "$notification.host.display_name$"
        "-o" = "$notification.host.output$"
        "-r" = "$notification.user.email$"
        "-s" = "$notification.host.state$"
        "-t" = "$notification.type$"
    }
    
    env = {
        NOTIFICATIONTYPE = "$notification.type$"
        HOSTNAME = "$notification.host.name$"
        HOSTDISPLAYNAME = "$notification.host.display_name$"
        HOSTADDRESS = "$notification.host.address$"
        HOSTSTATE = "$notification.host.state$"
        HOSTOUTPUT = "$notification.host.output$"
        NOTIFICATIONAUTHOR = "$notification.author$"
        NOTIFICATIONCOMMENT = "$notification.comment$"
        USEREMAIL = "$notification.user.email$"
    }
}

object NotificationCommand "mail-service-notification" {
    command = [ ConfigDir + "/scripts/mail-service-notification.sh" ]
    
    arguments = {
        "-4" = "$notification.host.address$"
        "-6" = "$notification.host.address6$"
        "-b" = "$notification.author$"
        "-c" = "$notification.comment$"
        "-d" = {
            required = true
            value = "$icinga.long_date_time$"
        }
        "-e" = "$notification.service.name$"
        "-l" = "$notification.host.name$"
        "-n" = "$notification.host.display_name$"
        "-o" = "$notification.service.output$"
        "-r" = "$notification.user.email$"
        "-s" = "$notification.service.state$"
        "-t" = "$notification.type$"
        "-u" = "$notification.service.display_name$"
    }
    
    env = {
        NOTIFICATIONTYPE = "$notification.type$"
        HOSTNAME = "$notification.host.name$"
        HOSTDISPLAYNAME = "$notification.host.display_name$"
        HOSTADDRESS = "$notification.host.address$"
        SERVICENAME = "$notification.service.name$"
        SERVICEDISPLAYNAME = "$notification.service.display_name$"
        SERVICESTATE = "$notification.service.state$"
        SERVICEOUTPUT = "$notification.service.output$"
        NOTIFICATIONAUTHOR = "$notification.author$"
        NOTIFICATIONCOMMENT = "$notification.comment$"
        USEREMAIL = "$notification.user.email$"
    }
}

// ============================================================
// NOTIFICATION TEMPLATES
// ============================================================

template Notification "mail-host-notification-template" {
    command = "mail-host-notification"
    
    // Sofort benachrichtigen
    interval = 0  // 0 = nur einmal, oder z.B. 30m für alle 30 Min
    
    // Bei welchen Zuständen
    states = [ Up, Down ]
    types = [ Problem, Acknowledgement, Recovery, Custom ]
    
    // Zeitraum - Standard: 24x7
    period = "24x7"
}

template Notification "mail-service-notification-template" {
    command = "mail-service-notification"
    
    // Sofort benachrichtigen
    interval = 0
    
    // Bei welchen Zuständen
    states = [ OK, Warning, Critical, Unknown ]
    types = [ Problem, Acknowledgement, Recovery, Custom ]
    
    // Zeitraum - Standard: 24x7
    period = "24x7"
}

// ============================================================
// NOTIFICATION APPLY RULES
// Diese Regeln bestimmen, wer bei welchen Hosts/Services benachrichtigt wird
// ============================================================

/**
 * Host Notifications an Admin-Gruppe
 * Gilt für alle Hosts
 */
apply Notification "mail-host-admin" to Host {
    import "mail-host-notification-template"
    
    // An diese User/Gruppe senden
    user_groups = [ "icingaadmins" ]
    
    // Gilt für alle Hosts
    assign where host.name != ""
}

/**
 * Service Notifications an Admin-Gruppe
 * Gilt für alle Services
 */
apply Notification "mail-service-admin" to Service {
    import "mail-service-notification-template"
    
    // An diese User/Gruppe senden
    user_groups = [ "icingaadmins" ]
    
    // Gilt für alle Services
    assign where service.name != ""
}

/**
 * OPTIONAL: Kritische Systeme → Bereitschaft (24x7)
 * Aktivieren durch Entfernen der Kommentare
 */
/*
apply Notification "mail-host-oncall" to Host {
    import "mail-host-notification-template"
    users = [ "oncall" ]
    
    // Nur für Hosts mit vars.critical = true
    assign where host.vars.critical == true
}

apply Notification "mail-service-oncall" to Service {
    import "mail-service-notification-template"
    users = [ "oncall" ]
    
    // Nur für kritische Services
    assign where service.vars.critical == true || host.vars.critical == true
}
*/

/**
 * OPTIONAL: Nur Geschäftszeiten für bestimmte Hosts
 * Aktivieren durch Entfernen der Kommentare
 */
/*
apply Notification "mail-host-businesshours" to Host {
    import "mail-host-notification-template"
    period = "business-hours"  // Nur Mo-Fr 8-18 Uhr
    
    user_groups = [ "icingaadmins" ]
    
    // Nur für Hosts mit vars.businesshours_only = true
    assign where host.vars.businesshours_only == true
}
*/
