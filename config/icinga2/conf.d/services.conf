/*
 * Service Apply Rules
 * 
 * Hier werden Services automatisch auf Hosts angewendet,
 * basierend auf deren Variablen (vars).
 * 
 * Abhängigkeiten:
 *   - commands.conf  : Check-Kommandos
 *   - templates.conf : Service- und Host-Templates
 */

/* ============================================
 * ALLGEMEINE CHECKS (alle Hosts)
 * ============================================ */

/* Ping Check - gilt für alle Hosts mit IP */
apply Service "ping4" {
  import "generic-service"
  check_command = "ping4"
  
  /* Nutze Host-Variablen mit Fallback auf globale Defaults */
  vars.ping_wrta = host.vars.ping_wrta ? host.vars.ping_wrta : ThresholdDefaults.ping_wrta
  vars.ping_crta = host.vars.ping_crta ? host.vars.ping_crta : ThresholdDefaults.ping_crta
  vars.ping_wpl = host.vars.ping_wpl ? host.vars.ping_wpl : ThresholdDefaults.ping_wpl
  vars.ping_cpl = host.vars.ping_cpl ? host.vars.ping_cpl : ThresholdDefaults.ping_cpl
  
  assign where host.address
}

/* HTTP Check für Hosts mit http_vhosts */
apply Service for (http_vhost => config in host.vars.http_vhosts) {
  import "generic-service"
  check_command = "http"
  vars += config
  
  /* Defaults falls nicht in config gesetzt */
  vars.http_warn_time = config.http_warn_time ? config.http_warn_time : ThresholdDefaults.http_warn_time
  vars.http_critical_time = config.http_critical_time ? config.http_critical_time : ThresholdDefaults.http_critical_time
}

/* TCP Port Checks */
apply Service for (tcp_port => config in host.vars.tcp_ports) {
  import "generic-service"
  check_command = "tcp"
  vars += config
  vars.tcp_port = tcp_port
  vars.tcp_timeout = config.tcp_timeout ? config.tcp_timeout : ThresholdDefaults.tcp_timeout
}

/* UDP Port Checks */
apply Service for (udp_port => config in host.vars.udp_ports) {
  import "generic-service"
  check_command = "udp"
  vars += config
  vars.udp_port = udp_port
}

/* ============================================
 * LINUX CHECKS (lokal oder via NRPE)
 * ============================================
 * 
 * Diese Checks nutzen die Host-Variablen für Thresholds.
 * Hosts die "linux-host" Template importieren erben die Defaults.
 * Einzelne Hosts können die Werte überschreiben.
 */

apply Service "ssh" {
  import "generic-service"
  check_command = "ssh"
  assign where host.vars.os == "Linux" && !host.vars.disable_ssh_check
}

apply Service for (disk => config in host.vars.disks) {
  import "generic-service"
  check_command = "disk"
  vars += config
  
  /* Nutze Host-Variablen mit Fallback */
  vars.disk_wfree = config.disk_wfree ? config.disk_wfree : (100 - host.vars.disk_warning) + "%"
  vars.disk_cfree = config.disk_cfree ? config.disk_cfree : (100 - host.vars.disk_critical) + "%"
}

apply Service "load" {
  import "generic-service"
  check_command = "load"
  
  /* Parse Warning/Critical aus Host-Variablen */
  vars.load_wload1 = host.vars.load_warning ? host.vars.load_warning.split(",")[0] : 5
  vars.load_wload5 = host.vars.load_warning ? host.vars.load_warning.split(",")[1] : 4
  vars.load_wload15 = host.vars.load_warning ? host.vars.load_warning.split(",")[2] : 3
  vars.load_cload1 = host.vars.load_critical ? host.vars.load_critical.split(",")[0] : 10
  vars.load_cload5 = host.vars.load_critical ? host.vars.load_critical.split(",")[1] : 8
  vars.load_cload15 = host.vars.load_critical ? host.vars.load_critical.split(",")[2] : 6
  
  assign where host.vars.os == "Linux"
}

apply Service "procs" {
  import "generic-service"
  check_command = "procs"
  
  vars.procs_warning = host.vars.procs_warning ? host.vars.procs_warning : ThresholdDefaults.procs_warning
  vars.procs_critical = host.vars.procs_critical ? host.vars.procs_critical : ThresholdDefaults.procs_critical
  
  assign where host.vars.os == "Linux"
}

apply Service "swap" {
  import "generic-service"
  check_command = "swap"
  
  vars.swap_wfree = host.vars.swap_warning ? (100 - host.vars.swap_warning) + "%" : "50%"
  vars.swap_cfree = host.vars.swap_critical ? (100 - host.vars.swap_critical) + "%" : "20%"
  
  assign where host.vars.os == "Linux"
}

apply Service "users" {
  import "generic-service"
  check_command = "users"
  
  vars.users_wgreater = host.vars.users_warning ? host.vars.users_warning : ThresholdDefaults.users_warning
  vars.users_cgreater = host.vars.users_critical ? host.vars.users_critical : ThresholdDefaults.users_critical
  
  assign where host.vars.os == "Linux"
}

apply Service "linux-uptime" {
  import "lowfreq-service"
  check_command = "snmp-uptime"
  assign where host.vars.os == "Linux" && host.vars.snmp_community
}

/* ============================================
 * WINDOWS CHECKS (via SNMP)
 * ============================================ */

apply Service "windows-cpu" {
  import "generic-service"
  check_command = "windows-snmp-cpu"
  assign where host.vars.os == "Windows" && host.vars.snmp_community
}

apply Service "windows-memory" {
  import "generic-service"
  check_command = "windows-snmp-memory"
  assign where host.vars.os == "Windows" && host.vars.snmp_community
}

apply Service "windows-uptime" {
  import "lowfreq-service"
  check_command = "snmp-uptime"
  assign where host.vars.os == "Windows" && host.vars.snmp_community
}

/* Windows Services (benötigt NSClient++ oder Icinga Agent) */
apply Service for (service => config in host.vars.windows_services) {
  import "generic-service"
  check_command = "nscp-local-service"
  vars += config
  vars.nscp_service = service
}

/* ============================================
 * SNMP/NETZWERK CHECKS
 * ============================================ */

apply Service for (interface => config in host.vars.snmp_interfaces) {
  import "generic-service"
  check_command = "snmp-interface"
  vars += config
}

apply Service for (snmp_check => config in host.vars.snmp_checks) {
  import "generic-service"
  check_command = "snmp"
  vars += config
}

/* ============================================
 * PEARL EPIPHAN CHECKS
 * ============================================ */

apply Service "epiphan-webinterface" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/"
  vars.http_warn_time = 3
  vars.http_critical_time = 10
  assign where host.vars.device_type == "epiphan"
}

apply Service "epiphan-api" {
  import "generic-service"
  check_command = "epiphan-api-status"
  assign where host.vars.device_type == "epiphan" && host.vars.epiphan_api
}

apply Service for (channel => config in host.vars.epiphan_channels) {
  import "generic-service"
  check_command = "epiphan-channel"
  vars += config
  vars.epiphan_channel = channel
}

apply Service "epiphan-recording" {
  import "generic-service"
  check_command = "epiphan-recorder"
  assign where host.vars.device_type == "epiphan" && host.vars.epiphan_recording
}

/* ============================================
 * AUDIO/RADIO DEVICE CHECKS
 * ============================================ */

apply Service "dante-network" {
  import "critical-service"
  check_command = "dante-network"
  assign where host.vars.device_type == "audio" && host.vars.dante
}

apply Service "audio-webinterface" {
  import "generic-service"
  check_command = "http"
  vars.http_uri = "/"
  assign where host.vars.device_type == "audio" && host.vars.http_check
}

/* ============================================
 * WIRELESS MICROPHONE CHECKS
 * ============================================ */

apply Service "mic-battery" {
  import "critical-service"
  check_command = "shure-battery"
  assign where host.vars.device_type == "microphone" && host.vars.shure_battery_oid
}

apply Service "mic-rf-signal" {
  import "critical-service"
  check_command = "rf-signal"
  vars.rf_signal_oid = host.vars.mic_rf_oid
  assign where host.vars.device_type == "microphone" && host.vars.mic_rf_oid
}

/* Generischer Mikrofon Web-Check */
apply Service "mic-webinterface" {
  import "generic-service"
  check_command = "http"
  vars.http_uri = "/"
  assign where host.vars.device_type == "microphone" && host.vars.http_check
}

/* ============================================
 * BROADCAST/STREAMING DEVICE CHECKS
 * ============================================ */

/* Stream-URL Check (HLS/RTMP/etc.) */
apply Service for (stream => config in host.vars.streams) {
  import "critical-service"
  check_command = "http"
  vars += config
}

/* Icecast/Shoutcast Stream Check */
apply Service "icecast-status" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/status-json.xsl"
  vars.http_port = host.vars.icecast_port
  vars.http_string = "icestats"
  assign where host.vars.icecast_port
}

/* ============================================
 * APPLIKATIONS-CHECKS (ViMP, Panopto, mAirList, etc.)
 * 
 * Keine Templates - einfach Host-Variablen setzen:
 *   vars.vimp_url = "https://vimp.example.com"
 *   vars.panopto_url = "https://panopto.example.com"
 *   vars.mairlist_port = 9000
 * ============================================ */

/* ViMP Video Management Platform */
apply Service "vimp" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/api/health"
  vars.http_ssl = true
  vars.http_address = host.vars.vimp_url
  assign where host.vars.vimp_url
}

/* Panopto Video Platform */
apply Service "panopto" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/Panopto/Pages/Home.aspx"
  vars.http_ssl = true
  vars.http_address = host.vars.panopto_url
  assign where host.vars.panopto_url
}

/* mAirList Radio Automation - API Status */
apply Service "mairlist-api" {
  import "critical-service"
  check_command = "tcp"
  vars.tcp_port = host.vars.mairlist_port
  assign where host.vars.mairlist_port
}

/* mAirList On-Air Status (HTTP API) */
apply Service "mairlist-onair" {
  import "critical-service"
  check_command = "http"
  vars.http_port = host.vars.mairlist_http_port
  vars.http_uri = "/status"
  assign where host.vars.mairlist_http_port
}

/* Stereotool Audio Processor */
apply Service "stereotool" {
  import "critical-service"
  check_command = "tcp"
  vars.tcp_port = host.vars.stereotool_port
  assign where host.vars.stereotool_port
}

/* MicroMPX Audio over IP */
apply Service "micrompx" {
  import "critical-service"
  check_command = "tcp"
  vars.tcp_port = host.vars.micrompx_port
  assign where host.vars.micrompx_port
}

/* MicroMPX Web Interface */
apply Service "micrompx-web" {
  import "generic-service"
  check_command = "http"
  vars.http_port = host.vars.micrompx_web_port
  vars.http_uri = "/"
  assign where host.vars.micrompx_web_port
}

/* ============================================
 * PROZESS-CHECKS (für kritische Dienste)
 * 
 * Setze auf Host: vars.critical_processes = ["mairlist", "stereotool"]
 * ============================================ */

apply Service for (process => config in host.vars.critical_processes) {
  import "critical-service"
  check_command = "procs"
  vars.procs_command = process
  vars.procs_warning = "1:"
  vars.procs_critical = "1:"
}
