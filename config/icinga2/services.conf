/*
 * Service Apply Rules
 * 
 * Hier werden Services automatisch auf Hosts angewendet,
 * basierend auf deren Variablen (vars).
 * 
 * Abhängigkeiten:
 *   - commands.conf  : Check-Kommandos
 *   - templates.conf : Service- und Host-Templates
 */

/* ============================================
 * ALLGEMEINE CHECKS (alle Hosts)
 * ============================================ */

/* Ping Check - gilt für alle Hosts mit IP */
apply Service "ping4" {
  import "generic-service"
  check_command = "ping4"
  assign where host.address
}

/* HTTP Check für Hosts mit http_vhosts */
apply Service for (http_vhost => config in host.vars.http_vhosts) {
  import "generic-service"
  check_command = "http"
  vars += config
}

/* TCP Port Checks */
apply Service for (tcp_port => config in host.vars.tcp_ports) {
  import "generic-service"
  check_command = "tcp"
  vars += config
  vars.tcp_port = tcp_port
}

/* UDP Port Checks */
apply Service for (udp_port => config in host.vars.udp_ports) {
  import "generic-service"
  check_command = "udp"
  vars += config
  vars.udp_port = udp_port
}

/* ============================================
 * LINUX CHECKS
 * ============================================ */

apply Service "ssh" {
  import "generic-service"
  check_command = "ssh"
  assign where host.vars.ssh_port
}

apply Service for (disk => config in host.vars.disks) {
  import "generic-service"
  check_command = "disk"
  vars += config
}

apply Service "load" {
  import "generic-service"
  check_command = "load"
  assign where host.vars.os == "Linux"
}

apply Service "procs" {
  import "generic-service"
  check_command = "procs"
  assign where host.vars.os == "Linux"
}

apply Service "memory" {
  import "generic-service"
  check_command = "swap"
  assign where host.vars.os == "Linux"
}

apply Service "users" {
  import "generic-service"
  check_command = "users"
  vars.users_wgreater = 5
  vars.users_cgreater = 10
  assign where host.vars.os == "Linux"
}

apply Service "linux-uptime" {
  import "lowfreq-service"
  check_command = "snmp-uptime"
  assign where host.vars.os == "Linux" && host.vars.snmp_community
}

/* ============================================
 * WINDOWS CHECKS (via SNMP)
 * ============================================ */

apply Service "windows-cpu" {
  import "generic-service"
  check_command = "windows-snmp-cpu"
  assign where host.vars.os == "Windows" && host.vars.snmp_community
}

apply Service "windows-memory" {
  import "generic-service"
  check_command = "windows-snmp-memory"
  assign where host.vars.os == "Windows" && host.vars.snmp_community
}

apply Service "windows-uptime" {
  import "lowfreq-service"
  check_command = "snmp-uptime"
  assign where host.vars.os == "Windows" && host.vars.snmp_community
}

/* Windows Services (benötigt NSClient++ oder Icinga Agent) */
apply Service for (service => config in host.vars.windows_services) {
  import "generic-service"
  check_command = "nscp-local-service"
  vars += config
  vars.nscp_service = service
}

/* ============================================
 * SNMP/NETZWERK CHECKS
 * ============================================ */

apply Service for (interface => config in host.vars.snmp_interfaces) {
  import "generic-service"
  check_command = "snmp-interface"
  vars += config
}

apply Service for (snmp_check => config in host.vars.snmp_checks) {
  import "generic-service"
  check_command = "snmp"
  vars += config
}

/* ============================================
 * PEARL EPIPHAN CHECKS
 * ============================================ */

apply Service "epiphan-webinterface" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/"
  vars.http_warn_time = 3
  vars.http_critical_time = 10
  assign where host.vars.device_type == "epiphan"
}

apply Service "epiphan-api" {
  import "generic-service"
  check_command = "epiphan-api-status"
  assign where host.vars.device_type == "epiphan" && host.vars.epiphan_api
}

apply Service for (channel => config in host.vars.epiphan_channels) {
  import "generic-service"
  check_command = "epiphan-channel"
  vars += config
  vars.epiphan_channel = channel
}

apply Service "epiphan-recording" {
  import "generic-service"
  check_command = "epiphan-recorder"
  assign where host.vars.device_type == "epiphan" && host.vars.epiphan_recording
}

/* ============================================
 * AUDIO/RADIO DEVICE CHECKS
 * ============================================ */

apply Service "dante-network" {
  import "critical-service"
  check_command = "dante-network"
  assign where host.vars.device_type == "audio" && host.vars.dante
}

apply Service "audio-webinterface" {
  import "generic-service"
  check_command = "http"
  vars.http_uri = "/"
  assign where host.vars.device_type == "audio" && host.vars.http_check
}

/* ============================================
 * WIRELESS MICROPHONE CHECKS
 * ============================================ */

apply Service "mic-battery" {
  import "critical-service"
  check_command = "shure-battery"
  assign where host.vars.device_type == "microphone" && host.vars.shure_battery_oid
}

apply Service "mic-rf-signal" {
  import "critical-service"
  check_command = "rf-signal"
  vars.rf_signal_oid = host.vars.mic_rf_oid
  assign where host.vars.device_type == "microphone" && host.vars.mic_rf_oid
}

/* Generischer Mikrofon Web-Check */
apply Service "mic-webinterface" {
  import "generic-service"
  check_command = "http"
  vars.http_uri = "/"
  assign where host.vars.device_type == "microphone" && host.vars.http_check
}

/* ============================================
 * BROADCAST/STREAMING DEVICE CHECKS
 * ============================================ */

/* Stream-URL Check (HLS/RTMP/etc.) */
apply Service for (stream => config in host.vars.streams) {
  import "critical-service"
  check_command = "http"
  vars += config
}

/* Icecast/Shoutcast Stream Check */
apply Service "icecast-status" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/status-json.xsl"
  vars.http_port = host.vars.icecast_port
  vars.http_string = "icestats"
  assign where host.vars.icecast_port
}

/* ============================================
 * APPLIKATIONS-CHECKS (ViMP, Panopto, mAirList, etc.)
 * 
 * Keine Templates - einfach Host-Variablen setzen:
 *   vars.vimp_url = "https://vimp.example.com"
 *   vars.panopto_url = "https://panopto.example.com"
 *   vars.mairlist_port = 9000
 * ============================================ */

/* ViMP Video Management Platform */
apply Service "vimp" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/api/health"
  vars.http_ssl = true
  vars.http_address = host.vars.vimp_url
  assign where host.vars.vimp_url
}

/* Panopto Video Platform */
apply Service "panopto" {
  import "critical-service"
  check_command = "http"
  vars.http_uri = "/Panopto/Pages/Home.aspx"
  vars.http_ssl = true
  vars.http_address = host.vars.panopto_url
  assign where host.vars.panopto_url
}

/* mAirList Radio Automation - API Status */
apply Service "mairlist-api" {
  import "critical-service"
  check_command = "tcp"
  vars.tcp_port = host.vars.mairlist_port
  assign where host.vars.mairlist_port
}

/* mAirList On-Air Status (HTTP API) */
apply Service "mairlist-onair" {
  import "critical-service"
  check_command = "http"
  vars.http_port = host.vars.mairlist_http_port
  vars.http_uri = "/status"
  assign where host.vars.mairlist_http_port
}

/* Stereotool Audio Processor */
apply Service "stereotool" {
  import "critical-service"
  check_command = "tcp"
  vars.tcp_port = host.vars.stereotool_port
  assign where host.vars.stereotool_port
}

/* MicroMPX Audio over IP */
apply Service "micrompx" {
  import "critical-service"
  check_command = "tcp"
  vars.tcp_port = host.vars.micrompx_port
  assign where host.vars.micrompx_port
}

/* MicroMPX Web Interface */
apply Service "micrompx-web" {
  import "generic-service"
  check_command = "http"
  vars.http_port = host.vars.micrompx_web_port
  vars.http_uri = "/"
  assign where host.vars.micrompx_web_port
}

/* ============================================
 * PROZESS-CHECKS (für kritische Dienste)
 * 
 * Setze auf Host: vars.critical_processes = ["mairlist", "stereotool"]
 * ============================================ */

apply Service for (process => config in host.vars.critical_processes) {
  import "critical-service"
  check_command = "procs"
  vars.procs_command = process
  vars.procs_warning = "1:"
  vars.procs_critical = "1:"
}
